<!doctype html><html lang=en><head><title>a n title</title><meta content="text/html; charset=utf-8" http-equiv=content-type><meta content="width=device-width,initial-scale=1.0,maximum-scale=1" name=viewport><meta content=noodp name=robots><link href=https://aniewoehner.github.io/blog/style.css rel=stylesheet><link href=https://aniewoehner.github.io/blog/color/orange.css rel=stylesheet><link href=https://aniewoehner.github.io/blog/color/background_dark.css rel=stylesheet><link href=https://aniewoehner.github.io/blog/font-hack.css rel=stylesheet><link href=https://aniewoehner.github.io/blog/rss.xml rel=alternate title=RSS type=application/rss+xml><link rel="shortcut icon" href=favicon-32x32.png type=image/png><body><div class=container><header class=header><div class=header__inner><div class=header__logo><a style="text-decoration: none;" href=https://aniewoehner.github.io/blog> <div class=logo>My blog</div> </a></div></div><nav class=menu><ul class=menu__inner><li class=active><a href=https://aniewoehner.github.io/blog/>Home</a><li><a href=https://aniewoehner.github.io/blog/projects/>Projects</a><li><a href=https://aniewoehner.github.io/blog/blog/>Blog</a><li><a href=https://aniewoehner.github.io/blog/tags/>Tags</a><li><a href=https://aniewoehner.github.io/blog/links/>Links</a><li><a href=https://aniewoehner.github.io/blog/about>Contact/About</a><li><a rel="noopener noreferrer" href=https://github.com/aniewoehner target=_blank>github</a></ul></nav></header><div class=content><div class=post><h1 class=post-title><a href=https://aniewoehner.github.io/blog/pages/esphome/esphome/>esphome</a></h1><div class=post-meta-inline><span class=post-date> 2022-12-05 </span></div><span class=post-tags-inline> :: tags:  <a class=post-tag href=https://aniewoehner.github.io/blog/tags/computer/>#computer</a>  <a class=post-tag href=https://aniewoehner.github.io/blog/tags/hardware/>#hardware</a>  <a class=post-tag href=https://aniewoehner.github.io/blog/tags/firmware/>#firmware</a></span><div class=post-content><p>framework for IoT using Espressif esp32 and/or other similar hardware alternative framework: [[tasmota]] <a href=/tasmota>tasmota</a> example of camera: [[zola_blog_content/computer/espcam]] <a href=espcam>espcam</a> <a href=esp32-cam></a><h2 id=why>why</h2><p>esphome replacing tasmota<ul><li>allows better integration with home assistant<li>allows actions that do not require the controller?<li>builds using python<li>next steps:<li>newest esphome requires newer python than on renegade/201 <ul><li>build firmware elsewhere<li>possible to program from renegade/201?</ul><li>Can migrate between Tasmota and esphome, firmware is uploadable through the web interface <ul><li>Insufficient space? Use the gzip version of the firmware.bin</ul></ul><h1 id=building>Building</h1><ul><li>Use a python virtual environment to be able to maintain versions of libraries</ul><pre class=language-sh data-lang=sh style=background-color:#151515;color:#e8e8d3;><code class=language-sh data-lang=sh><span style=color:#ffb964;>python</span><span> venv
</span><span>source py /bin/activate
</span><span style=color:#8fbfdc;>export </span><span style=color:#ffb964;>PIP_CACHE_DIR</span><span>=&LTpath>
</span><span style=color:#ffb964;>python3 -m</span><span> pip install</span><span style=color:#ffb964;> --upgrade</span><span> pip
</span><span style=color:#ffb964;>python3 -m</span><span> pip install</span><span style=color:#ffb964;> --upgrade</span><span> wheel
</span><span style=color:#ffb964;>PLATFORMIO_CORE_DIR</span><span>=</span><span style=color:#99ad6a;>$( pwd )/dot_platformio
</span><span style=color:#8fbfdc;>export </span><span style=color:#ffb964;>PLATFORMIO_CORE_DIR
</span><span style=color:#ffb964;>mkdir -p </span><span>${</span><span style=color:#ffb964;>PLATFORMIO_CORE_DIR</span><span>}
</span><span style=color:#ffb964;>python3 -m</span><span> pip install</span><span style=color:#ffb964;> --upgrade</span><span> esphome
</span><span style=color:#ffb964;>this</span><span> brings in platformio?
</span><span style=color:#ffb964;>pio</span><span> upgrade?
</span></code></pre><ul><li>Or container image</ul><pre class=language-sh data-lang=sh style=background-color:#151515;color:#e8e8d3;><code class=language-sh data-lang=sh><span style=color:#ffb964;>docker</span><span> run</span><span style=color:#ffb964;> --rm --net</span><span>=host</span><span style=color:#ffb964;> -v </span><span style=color:#556633;>"</span><span style=color:#99ad6a;>${</span><span style=color:#ffb964;>PWD</span><span style=color:#99ad6a;>}</span><span style=color:#556633;>"</span><span>:/config</span><span style=color:#ffb964;> -it</span><span> esphome/esphome
</span></code></pre><ul><li>Start building a basic configuration yaml for a device by using the wizard</ul><pre class=language-sh data-lang=sh style=background-color:#151515;color:#e8e8d3;><code class=language-sh data-lang=sh><span style=color:#ffb964;>esphome</span><span> wizard &LTdevicename>.yaml
</span></code></pre><ul><li><p>Edit that yaml</p><li><p>Build</p></ul><pre class=language-sh data-lang=sh style=background-color:#151515;color:#e8e8d3;><code class=language-sh data-lang=sh><span style=color:#ffb964;>esphome</span><span> compile <>.yaml
</span></code></pre><pre style=background-color:#151515;color:#e8e8d3;><code><span>- Older versions used esphome yaml compile
</span></code></pre><ul><li>Firmware produced will be in ./.esphome/build/<node>/.pioenvs/<node>/firmware.bin<li><ul><p><a href=https://esphome.io/guides/configuration-types.html#config-substitutions>https://esphome.io/guides/configuration-types.html#config-substitutions</a> esphome config <>.yaml<pre class=language-sh data-lang=sh style=background-color:#151515;color:#e8e8d3;><code class=language-sh data-lang=sh><span style=color:#ffb964;>sourc</span><span> ed venv
</span><span style=color:#ffb964;>python3 -m</span><span> pip install</span><span style=color:#ffb964;> --upgrade</span><span> pip
</span><span style=color:#ffb964;>python3 -m</span><span> pip install</span><span style=color:#ffb964;> --upgrade</span><span> wheel
</span><span style=color:#ffb964;>python3 -m</span><span> pip install</span><span style=color:#ffb964;> --upgrade</span><span> cryptography
</span><span style=color:#ffb964;>python3 -m</span><span> pip install</span><span style=color:#ffb964;> --upgrade</span><span> esphome
</span><span>
</span><span style=color:#ffb964;>esphome</span><span> version
</span><span>
</span><span style=color:#ffb964;>esphome</span><span> wizard <>.yaml
</span><span>	</span><span style=color:#ffb964;>like</span><span> device_name
</span><span style=color:#ffb964;>esphome</span><span> wizard sonoff_s31_01.yaml
</span><span>	</span><span style=color:#ffb964;>asks</span><span> name, give it the same name
</span><span>	</span><span style=color:#ffb964;>esp8266</span><span> platform for all sonoff?
</span><span>	</span><span style=color:#ffb964;>but</span><span> then esp8285 board?
</span></code></pre><p>serial console adapter for rock64 default is 1.5M baud, why? 3v3 signaling but some sort of problem prevents boot serial@ff13000<h3 id=advanced-sensor-creation>Advanced sensor creation</h3><ul><li>generally falls under the idea of template based sensor and follows home assistant</ul><pre class=language-yaml data-lang=yaml style=background-color:#151515;color:#e8e8d3;><code class=language-yaml data-lang=yaml><span>- </span><span style=color:#ffb964;>platform</span><span>: </span><span style=color:#99ad6a;>template
</span><span>  </span><span style=color:#ffb964;>sensors</span><span>:
</span><span>    </span><span style=color:#ffb964;>something_state</span><span>:
</span><span>      </span><span style=color:#ffb964;>friendly_name</span><span>: </span><span style=color:#99ad6a;>something_status
</span><span>      </span><span style=color:#ffb964;>value_template</span><span>: </span><span style=color:#8fbfdc;>>-
</span><span style=color:#99ad6a;>      {% if
</span><span style=color:#99ad6a;>      (states()|int >= 5 and (as_timestamp(now())-(as_timestamp(states))))
</span><span style=color:#99ad6a;>      %}
</span><span style=color:#99ad6a;>        on
</span><span style=color:#99ad6a;>      {% else %}
</span><span style=color:#99ad6a;>        off
</span><span style=color:#99ad6a;>      {% endif %}
</span></code></pre><div></div><div><footer class=footer><div class=footer__inner><div class="copyright copyright--user">My custom <b>copyright</b></div></div></footer></div>